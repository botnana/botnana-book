<!DOCTYPE HTML>
<html lang="zh-TW" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>狀態流程圖 Sequential Function Chart (SFC) - Botnana Book</title>


        <!-- Custom HTML head -->

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> 簡介</a></li><li class="chapter-item expanded "><a href="hardware.html"><strong aria-hidden="true">2.</strong> 硬體規格</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="botnana-a2.html"><strong aria-hidden="true">2.1.</strong> Botnana BN-A2A</a></li><li class="chapter-item expanded "><a href="botnana-bn-j4a.html"><strong aria-hidden="true">2.2.</strong> Botnana BN-J4A</a></li></ol></li><li class="chapter-item expanded "><a href="software.html"><strong aria-hidden="true">3.</strong> 軟體規格</a></li><li class="chapter-item expanded "><a href="roadmap.html"><strong aria-hidden="true">4.</strong> Roadmap</a></li><li class="chapter-item expanded "><a href="tutorial.html"><strong aria-hidden="true">5.</strong> 入門教學</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="botnana-a2-tutorial.html"><strong aria-hidden="true">5.1.</strong> Botnana A2 入門</a></li><li class="chapter-item expanded "><a href="botnana-control-tutorial.html"><strong aria-hidden="true">5.2.</strong> Botnana Control 入門</a></li></ol></li><li class="chapter-item expanded "><a href="configuration-file.html"><strong aria-hidden="true">6.</strong> 設定檔</a></li><li class="chapter-item expanded "><a href="programming.html"><strong aria-hidden="true">7.</strong> 程式開發界面</a></li><li class="chapter-item expanded "><a href="json-api.html"><strong aria-hidden="true">8.</strong> JSON API</a></li><li class="chapter-item expanded "><a href="real-time-script-api.html"><strong aria-hidden="true">9.</strong> Real-time Script API</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="host-primitives.html"><strong aria-hidden="true">9.1.</strong> Botnana 基本指令集</a></li><li class="chapter-item expanded "><a href="ethercat-primitives.html"><strong aria-hidden="true">9.2.</strong> EtherCAT 指令集</a></li><li class="chapter-item expanded "><a href="ethercat-drive-primitives.html"><strong aria-hidden="true">9.3.</strong> EtherCAT Drive 指令集</a></li><li class="chapter-item expanded "><a href="ethercat-io-primitives.html"><strong aria-hidden="true">9.4.</strong> EtherCAT IO 指令集</a></li><li class="chapter-item expanded "><a href="ethercat-uart-primitives.html"><strong aria-hidden="true">9.5.</strong> EtherCAT UART 指令集</a></li><li class="chapter-item expanded "><a href="ethercat-encoder-primitives.html"><strong aria-hidden="true">9.6.</strong> EtherCAT Encoder 指令集</a></li><li class="chapter-item expanded "><a href="ethercat-gateway-primitives.html"><strong aria-hidden="true">9.7.</strong> EtherCAT Gateway 指令集</a></li><li class="chapter-item expanded "><a href="axis-group.html"><strong aria-hidden="true">9.8.</strong> 軸組 Axis Group 指令集</a></li><li class="chapter-item expanded "><a href="sfc.html" class="active"><strong aria-hidden="true">9.9.</strong> 狀態流程圖 Sequential Function Chart (SFC)</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="sfc-example/servo-on-off.html"><strong aria-hidden="true">9.9.1.</strong> Servo On/OFF</a></li><li class="chapter-item expanded "><a href="sfc-example/motion-state.html"><strong aria-hidden="true">9.9.2.</strong> Motion State</a></li><li class="chapter-item expanded "><a href="sfc-example/axes-homing.html"><strong aria-hidden="true">9.9.3.</strong> Homing State</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="known-working-hardware.html"><strong aria-hidden="true">10.</strong> 支援的硬體清單</a></li><li class="chapter-item expanded "><a href="update-software.html"><strong aria-hidden="true">11.</strong> 軟體更新</a></li><li class="chapter-item expanded "><a href="faq.html"><strong aria-hidden="true">12.</strong> 常見問題</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="faq/network.html"><strong aria-hidden="true">12.1.</strong> 網路設定</a></li><li class="chapter-item expanded "><a href="faq/gadget.html"><strong aria-hidden="true">12.2.</strong> USB連線IP設定</a></li><li class="chapter-item expanded "><a href="faq/windows7_rndis.html"><strong aria-hidden="true">12.3.</strong> Windows 7 RNDIS 驅動程式安裝</a></li><li class="chapter-item expanded "><a href="faq/windows10_rndis.html"><strong aria-hidden="true">12.4.</strong> Windows 10 RNDIS 驅動程式安裝</a></li><li class="chapter-item expanded "><a href="faq/win10_permission.html"><strong aria-hidden="true">12.5.</strong> Windows 10 檔案權限修改</a></li><li class="chapter-item expanded "><a href="faq/mount.html"><strong aria-hidden="true">12.6.</strong> 磁碟掛載 Mount</a></li><li class="chapter-item expanded "><a href="faq/manual_install_deb/manual_install_deb.html"><strong aria-hidden="true">12.7.</strong> 手動安裝 Botnana Control 更新檔</a></li><li class="spacer"></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Botnana Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h3 id="順序功能流程指令"><a class="header" href="#順序功能流程指令">順序功能流程指令</a></h3>
<p>順序功能流程圖 Sequential Function Chart (SFC) 是 PLC 五種語言中的一種，是一種圖形程式語言。它的主要成份有：</p>
<ul>
<li>步驟 (Step) 及其相關的動作。</li>
<li>轉態 (Transition) 及其相關的邏輯條件。</li>
<li>步驟及轉換之間的連結。</li>
</ul>
<p>Botnana Control 提供了支援順序功能流程圖的指令集，可以把 Forth 指令轉變成順序功能流程圖中的「步驟」及「轉態」，並建立步驟及轉態之間的連結。</p>
<p>此外，Botnana Control 內建了一個執行順序功能流程圖的引擎，並且指派了多工系統中的一個 Task 負責執行這個引擎。這個 Task 會在每個控制週期執行以下運算：</p>
<pre><code>SFC Engine:

    +-----------+
    |           |
    |           v
    |   +---------------------+
    |   | pause               | CPU 控制權轉給下一 Task。
    |   +---------------------+
    |           |
    |           v 下一個週期時，控制權會再回到這個 Task。
    |   +----------------------+
    |   | execute_active_steps | 執行所有 active 的步驟。
    |   +----------------------+
    |           |
    |           v
    |   +----------------------------+
    |   | execute_active_transitions | 執行所有 active 的轉態。
    |   +----------------------------+
    |           |
    |           v
    |   +---------------+
    |   | update_states | 依轉態的結果，更新步驟的 active 狀態。
    |   +---------------+
    |           |
    +-----------+
</code></pre>
<p>以下以紅綠燈為例：</p>
<pre><code>     r2g        g2y         y2r
red -+-&gt; green -+-&gt; yellow -+-
 ^                           |
 |                           |
 -----------------------------
</code></pre>
<h4 id="步驟-step"><a class="header" href="#步驟-step">步驟 (Step)</a></h4>
<p>red、green、yellow 分別是紅、綠、黃三個步驟。以下定義了紅黃綠三種步驟的相關動作。在此動作只是印出 r、g、y 三個字母。</p>
<pre><code>: red ( - )  .&quot; r&quot; ;
: green ( - )  .&quot; g&quot; ;
: yellow ( - )  .&quot; y&quot; ;
</code></pre>
<p>以 step 指令宣告 red、green、yellow 是順序流程圖中的步驟。</p>
<pre><code>step red
step green
step yellow
</code></pre>
<p>執行步驟動作的指令不需要堆疊上的參數，也不應產生資料到堆疊上。指令 <code>step</code> 會在 Botnana Control 內建的 SFC 引擎中建立一個和其後指令同名的步驟。並使得當這個步驟為 active 時，會不斷執行此一指令。</p>
<h4 id="啟用-activate"><a class="header" href="#啟用-activate">啟用 (Activate)：</a></h4>
<p>一個順序狀態流程圖要能運作，至少有一個 active 的步驟。指令 <code>+step</code> 會啟用堆疊上的「令牌」對應的步驟，使其 active。以下敘述啟用了步驟 red。</p>
<pre><code>' red  +step
</code></pre>
<h4 id="轉態-transition"><a class="header" href="#轉態-transition">轉態 (Transition)</a></h4>
<p>r2g、g2y、y2r 分別是紅轉綠、綠轉黃、黃轉紅三種轉態。以下定義了三個轉態的相關邏輯條件。在此條件都是假，也就是不會轉態。</p>
<pre><code>: r2g ( - t )  false ;
: g2y ( - t )  false ;
: y2r ( - t )  false ;
</code></pre>
<p>以 transition 指令宣告 r2g、g2y、y2r 是順序流程圖中的轉態。</p>
<pre><code>transition r2g
transition g2y
transition y2r
</code></pre>
<p>執行轉態邏輯條件的指令不需要堆疊上的參數，但會在堆疊上產生一對應轉態條件的布林值。指令 <code>transition</code> 會在 Botnana Control 內建的 SFC 引擎中建立一個和其後指令同名的轉態。並在引擎運轉，當這個轉態前<strong>所有</strong>的步驟都為 active 時，執行此一條件指令，並檢查這指令留在堆疊上的數值。如果數值為真，就會使得轉態之前的步驟不再 active，並使得轉態後的步驟變成 active。</p>
<h4 id="連結"><a class="header" href="#連結">連結</a></h4>
<p>步驟 red 連結到轉態 r2g，轉態 r2g 又連結到步驟 green。指令 <code>--&gt;</code> 會從堆疊上取得步驟或轉態的「令牌 (execution token)，一個代表指令的數字，建立令牌所代表的步驟及轉態之間的連結。在 Forth 使用 <code>'</code> 可以取得其後指令的令牌。 以下程式建立了上圖中的連結。</p>
<pre><code>' red  ' r2g  --&gt;
' r2g  ' green  --&gt;
' green  ' g2y  --&gt;
' g2y  ' yellow  --&gt;
' yellow  ' y2r  --&gt;
' y2r  ' red  --&gt;
</code></pre>
<h4 id="平行-and-結構"><a class="header" href="#平行-and-結構">平行 AND 結構</a></h4>
<p>順序狀態流程有所有的平行處理的結構，或稱 AND 結構，如下圖，當轉態 t1 發生時，步驟 B 和步驟 C 都會 active。</p>
<pre><code>      ||-&gt; B --&gt;||
   t1 ||        || t2     t3
A -+--||-&gt; C --&gt;||-+-&gt; D -+-
^                          |
|                          |
----------------------------
</code></pre>
<p>以下程式建立上圖中的流程圖。</p>
<pre><code>step A
step B
step C
step D

' A  +step

transition t1
transition t2
transition t3

' A  ' t1  --&gt;
' t1  ' B  --&gt;
' t1  ' C  --&gt;
' B  ' t2  --&gt;
' C  ' t2  --&gt;
' t2  ' D  --&gt;
' D  ' t3  --&gt;
' t3  ' A  --&gt;
</code></pre>
<h4 id="選擇-or-結構"><a class="header" href="#選擇-or-結構">選擇 OR 結構</a></h4>
<p>順序狀態流程有多選一的結構，或稱 OR 結構，如下圖，當步驟 A 為 active 時，若轉態 t1 為真，B 會在下一週期變為 active。若 t2 為真，則 C 在下一個週期變為 active。通常會設計使得 t1 和 t2 不會同時會真，達到二選一的目的。要注意如果 t1 和 t2 有可能同時為真，則 B 和 C 同時會 active，行為會類似之前的 AND 平行結構，但如果 t3 和 t4 不同時為真，則 D 可能由 t3 啟用一次，之後又被 t4 啟用一次，這樣的行為會變得難以分析。因此應避免 t1 和 t2 同時為真的設計。</p>
<pre><code>      t1     t3
    |-+-&gt; B -+-&gt;|
    | t2     t4 |       t5
A --|-+-&gt; C -+-&gt;|--&gt; D -+-
^                        |
|                        |
--------------------------
</code></pre>
<p>以下程式建立上圖中的流程圖。</p>
<pre><code>step A
step B
step C
step D

' A +step

transition t1
transition t2
transition t3
transition t4
transition t5

' A  ' t1  --&gt;
' A  ' t2  --&gt;
' t1  ' B  --&gt;
' t2  ' C  --&gt;
' B  ' t3  --&gt;
' C  ' t4  --&gt;
' t3  ' D  --&gt;
' t4  ' D  --&gt;
' D  ' t5  --&gt;
' t5  ' A  --&gt;
</code></pre>
<h4 id="本節指令集"><a class="header" href="#本節指令集">本節指令集</a></h4>
<table><thead><tr><th>指令</th><th>堆疊效果及指令說明</th><th>口語唸法</th></tr></thead><tbody>
<tr><td><code>step &lt;name&gt;</code></td><td>( -- )   在順序狀態流程引擎中定義一個名為 <code>&lt;name&gt;</code> 的步驟，並指派它的動作為指令 <code>&lt;name&gt;</code>。當步驟 <code>&lt;name&gt;</code> active 時，指令 <code>&lt;name&gt;</code> 每個週期都會被執行一次</td><td>step</td></tr>
<tr><td><code>+step</code></td><td>( xt -- )   設令牌 xt 對應的步驟為 active 。</td><td>plus-step</td></tr>
<tr><td><code>transition &lt;name&gt;</code></td><td>( -- )   在順序狀態流程引擎中定義一個名為 <code>&lt;name&gt;</code> 的轉態，並指派它的邏輯條件為指令 <code>&lt;name&gt;</code>。當轉態 <code>&lt;name&gt;</code> 之前的<strong>所有</strong>的步驟都為 active 時，指令 <code>&lt;name&gt;</code> 會被執行。順序狀態流程引擎會檢查執行後留在堆疊上的布林值，如果為真，就會轉態至其後的步驟</td><td>transition</td></tr>
<tr><td><code>--&gt;</code></td><td>( xt1 xt2 -- )   連結對應令牌 <code>xt1</code> 和 <code>xt2</code> 的步驟或轉態。步驟只能連結到轉態，而轉態只能連結到步驟，其他情況會產生錯誤訊息。</td><td>link-to</td></tr>
</tbody></table>
<hr />
<h3 id="其他常用的命令"><a class="header" href="#其他常用的命令">其他常用的命令</a></h3>
<h4 id="0sfc-----"><a class="header" href="#0sfc-----"><code>0sfc ( -- )</code></a></h4>
<p>停止所有執行中的 sfc，清除所有的 sfc 定義。</p>
<h4 id="elapsed---xt----time-"><a class="header" href="#elapsed---xt----time-"><code>elapsed  ( xt -- time ）</code></a></h4>
<p>取得 SFC 步驟（此步驟用令牌 <code>xt</code> 來指定）的執行時間　<code>time</code> ms。如果滿足轉態條件，重新進入指定步驟，此時間會重新計數。</p>
<h4 id="本節指令集-1"><a class="header" href="#本節指令集-1">本節指令集</a></h4>
<table><thead><tr><th>指令</th><th>堆疊效果</th></tr></thead><tbody>
<tr><td>0sfc</td><td>( -- )</td></tr>
<tr><td>elapsed</td><td>（ xt -- time）</td></tr>
</tbody></table>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="axis-group.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="sfc-example/servo-on-off.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="axis-group.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="sfc-example/servo-on-off.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script type="text/javascript">
            var socket = new WebSocket("ws://localhost:3000/__livereload");
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
